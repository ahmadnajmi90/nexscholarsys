import{r as n,q as R,j as e,a as T,Y as z}from"./app-DlrLkdql.js";import{C as $}from"./card-BIYhEdWl.js";import"./scroll-area-CcD72brL.js";import{C as q,M as F}from"./MainLayout-CaDLPfY8.js";import{l as P,T as G}from"./ThreadPane-B2-NznzI.js";import{B as W}from"./button-CmAFW6Q4.js";import{c as B}from"./utils-CBfrqCZ4.js";import{A as D,a as H}from"./avatar-BUsG5DLW.js";import{c as Y}from"./index-B_EXF9H_.js";import"./index-_t9AzER0.js";import"./index-BPUO_Du-.js";import"./index-CooGWVRp.js";import"./index-DTEdqLdY.js";import"./index-MQT5_bdA.js";import"./index-BdQq_4o_.js";import"./house-DhqGzN5G.js";import"./createLucideIcon-DuVmJdM5.js";import"./zap-C5sZ12y6.js";import"./users-DIbmjsPC.js";import"./folder-open-BeKiZvsi.js";import"./settings-CYYGlRx6.js";import"./useRoles-Qm-DlQme.js";import"./chevron-left-D4CJlqlf.js";import"./proxy-9_5LvuaU.js";import"./user-round-COXXmn1M.js";import"./clipboard-list-B_J7gyqU.js";import"./dollar-sign-CfrQ8X-j.js";import"./calendar-BUDN8Wve.js";import"./file-text-DuT2_NhJ.js";import"./message-square-Ns6phRZt.js";import"./graduation-cap-ByJq4Rk3.js";import"./building-BnusGjoU.js";import"./Dropdown-CyPVq9Ib.js";import"./transition-CrpKBowS.js";import"./sparkles-B8I717mR.js";import"./bookmark-CHxePipJ.js";import"./folder-kanban-DrAARP9_.js";import"./building-2-BVV_ifkz.js";import"./database-BVDqe0Nq.js";import"./shield-1ZrIkVDR.js";import"./index-raKJPBbr.js";import"./analytics-BQ374C1C.js";import"./iconBase-CNX8JClf.js";import"./index-C4Dw6-hd.js";import"./supervisionConstants-BuM5-H5X.js";import"./isSameDay-BHs4V-zU.js";import"./en-US-DIdCsyf3.js";import"./format-BOijCLBA.js";import"./constructNow-6bIQB1GK.js";import"./addDays-KHeCUDUr.js";import"./Modal-Cu2styYL.js";import"./dialog-C4T7sENw.js";import"./PrimaryButton-jNMHCCwm.js";import"./SecondaryButton-COLypBy8.js";import"./search-C39YJhqP.js";import"./circle-check-big-BEClqQUa.js";import"./x-CaP1GlTY.js";import"./chevron-right-EHi25R_G.js";import"./tooltip-Y6AC5kbZ.js";import"./index-Cua-v5t-.js";import"./index-BiBX-aEh.js";import"./index-Fs6G4e3d.js";import"./floating-ui.dom-D5EC_49c.js";import"./index-Ci_0jHjH.js";import"./index-DliD_jgu.js";import"./index-6fNHbBBE.js";import"./index-Chjiymov.js";import"./dialog-B93jKqok.js";import"./index-C46cEohh.js";import"./index-C4hYSks0.js";import"./briefcase-BY2whaIk.js";import"./user-Dp2DubXk.js";import"./download-C9BmgKLA.js";function J({conversations:c=[],activeConversationId:x=null,onSearchChange:w,onSelectConversation:l}){const[d,f]=n.useState(""),{url:j}=R(),g=P.debounce(i=>{w&&w(i)},300),N=i=>{const m=i.target.value;f(m),g(m)};return n.useEffect(()=>()=>{g.cancel()},[]),e.jsxs("div",{className:"h-full flex flex-col min-w-0 overflow-hidden",children:[e.jsx("div",{className:"p-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search conversations...",value:d,onChange:N,className:"w-full p-2 pl-8 text-sm bg-muted/50 border-0 rounded-lg focus:ring-1 focus:ring-primary min-w-0"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsx("div",{className:"flex-1 min-w-0 overflow-y-auto overflow-x-hidden",children:e.jsx("div",{className:"p-3 space-y-1 min-w-0 overflow-hidden",children:c.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No conversations found"}):c.map(i=>e.jsx(q,{conversation:i,isActive:x===i.id,onSelect:l},i.id))})})]})}function K({isOpen:c,onClose:x,onCreateConversation:w}){const[l,d]=n.useState("direct"),[f,j]=n.useState(""),[g,N]=n.useState([]),[i,m]=n.useState([]),[y,C]=n.useState(""),[u,b]=n.useState(!1),[v,S]=n.useState(!1),k=async(t="")=>{b(!0);try{const r=await T.get("/api/v1/app/connections",{params:{q:t,per_page:50}});N(r.data.data||[])}catch(r){console.error("Error fetching connections:",r)}finally{b(!1)}},L=n.useMemo(()=>P.debounce(t=>{t.trim()&&k(t)},300),[]);n.useEffect(()=>{c&&k("")},[c]),n.useEffect(()=>{c&&f.trim()&&L(f)},[f,L,c]);const M=g,E=t=>{if(l==="direct")m([t]);else{const r=i.some(s=>s.id===t.id);m(r?i.filter(s=>s.id!==t.id):[...i,t])}},I=t=>i.some(r=>r.id===t),U=async()=>{if(!(l==="direct"&&i.length!==1||l==="group"&&(i.length<1||!y.trim()))){S(!0);try{const t=l==="direct"?{type:"direct",user_id:i[0].id}:{type:"group",title:y.trim(),user_ids:i.map(r=>r.id)};w&&await w(t),_()}catch(t){console.error("Error creating conversation:",t)}finally{S(!1)}}},_=()=>{d("direct"),j(""),m([]),C(""),x()};return c?e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-medium",children:"New Conversation"}),e.jsx("button",{onClick:_,className:"p-1 rounded-full hover:bg-muted",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{className:B("flex-1 py-3 text-center font-medium",l==="direct"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),onClick:()=>d("direct"),children:"Direct Message"}),e.jsx("button",{className:B("flex-1 py-3 text-center font-medium",l==="group"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),onClick:()=>d("group"),children:"Group Chat"})]}),l==="group"&&e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("label",{htmlFor:"group-title",className:"block text-sm font-medium text-gray-700 mb-1",children:"Group Name"}),e.jsx("input",{type:"text",id:"group-title",value:y,onChange:t=>C(t.target.value),placeholder:"Enter group name",className:"w-full p-2 border rounded-md",required:!0})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:`Search ${l==="direct"?"connections":"participants"}...`,value:f,onChange:t=>j(t.target.value),className:"w-full p-2 pl-8 border rounded-md"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-1",children:u?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):M.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No connections found"}):e.jsx("div",{className:"space-y-1",children:M.map(t=>{const r=t.user,s=I(r.id);return e.jsxs("div",{className:B("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",s?"bg-primary/10 text-primary":"hover:bg-muted/50"),onClick:()=>E(r),children:[e.jsxs("div",{className:"relative",children:[r.avatar_url?e.jsx(D,{src:r.avatar_url,alt:r.full_name||r.name}):e.jsx(D,{children:e.jsx(H,{className:"bg-primary/10 text-primary",children:(r.full_name||r.name||"U").charAt(0)})}),r.is_online===!0&&e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:r.full_name||r.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.role||"Connection"})]}),s&&e.jsx("div",{className:"text-primary",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]},r.id)})})}),e.jsxs("div",{className:"p-4 border-t flex justify-end gap-2",children:[e.jsx(W,{variant:"outline",onClick:_,disabled:v,children:"Cancel"}),e.jsx(W,{onClick:U,disabled:v||l==="direct"&&i.length!==1||l==="group"&&(i.length<1||!y.trim()),children:v?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating..."})]}):"Create"})]})]})}):null}function ht({auth:c}){const{flash:x,url:w}=R().props,[l,d]=n.useState([]),[f,j]=n.useState(!0),[g,N]=n.useState(""),[i,m]=n.useState(!1),[y,C]=n.useState(null),[u,b]=n.useState(null);n.useEffect(()=>{const r=new URLSearchParams(window.location.search).get("cid");r&&b(parseInt(r,10))},[]),n.useEffect(()=>{if(u){const t=new URLSearchParams(window.location.search);t.set("cid",u),window.history.replaceState({},"",`${window.location.pathname}?${t.toString()}`)}},[u]),n.useEffect(()=>{x.error&&Y.error(x.error)},[x]),n.useEffect(()=>{v();const t=setInterval(()=>{T.post("/api/v1/app/me/heartbeat").catch(r=>console.error("Heartbeat error:",r))},3e4);return()=>clearInterval(t)},[]);const v=async(t="")=>{j(!0),C(null);try{const r=await T.get("/api/v1/app/messaging/conversations",{params:{q:t}});d(r.data.data||[])}catch(r){console.error("Error fetching conversations:",r),C("Failed to load conversations. Please try again.")}finally{j(!1)}},S=P.debounce(t=>{N(t),v(t)},300),k=async t=>{try{const s=(await T.post("/api/v1/app/messaging/conversations",t)).data.data;return d(o=>o.some(p=>p.id===s.id)?o:[s,...o]),b(s.id),s}catch(r){throw console.error("Error creating conversation:",r),r}},L=t=>{b(t)},M=t=>{d(r=>r.map(s=>s.id===t?{...s,unread_count:0}:s))},E=t=>{d(r=>r.map(s=>s.id===t?{...s,unread_count:(s.unread_count??0)+1}:s))},I=(t,r)=>{d(s=>{const o=s.findIndex(h=>h.id===t);if(o===-1)return s;const a={...s[o],last_message:r,updated_at:r.created_at},p=[...s.slice(0,o),...s.slice(o+1)];return[a,...p]})},U=(t,r)=>{d(s=>s.map(o=>o.id===t?{...o,unread_count:0}:o)),I(t,r)};n.useEffect(()=>{const t=window.Echo.private(`App.Models.User.${c.user.id}`);return t.listen(".MessageSent",r=>{r.conversation_id!==u&&E(r.conversation_id),I(r.conversation_id,r.message)}),t.listen(".MessageEdited",r=>{d(s=>s.map(o=>o.last_message&&o.last_message.id===r.id?{...o,last_message:{...o.last_message,body:r.body,edited_at:r.edited_at}}:o))}),t.listen(".MessageDeleted",r=>{v(g)}),t.listen(".ConversationListDelta",r=>{_(r)}),()=>{t.stopListening(".MessageSent"),t.stopListening(".MessageEdited"),t.stopListening(".MessageDeleted"),t.stopListening(".ConversationListDelta")}},[c.user.id,u,g]);const _=t=>{d(r=>{if(!r)return r;const s=[...r],o=s.findIndex(A=>String(A.id)===String(t.conversation_id));if(o===-1)return r;const a={...s[o]},p=t.last_message_sender_id!=null?Number(t.last_message_sender_id):null;a.updated_at=t.updated_at??a.updated_at,a.title=t.title??a.title,a.icon_path=t.icon_path??a.icon_path,p!==null&&(a.last_message_sender_id=p);const h=a.last_message??{};if(a.last_message={...h,body:t.last_message_preview??h.body??"",preview:t.last_message_preview??h.preview??"",type:t.last_message_type??h.type??"text",sender:p!==null?{...h.sender??{},id:p}:h.sender??null},typeof t.unread_delta=="number"){const A=a.unread_count??0;a.unread_count=Math.max(0,A+t.unread_delta)}return s.splice(o,1),s.unshift(a),s})};return e.jsxs(F,{auth:c,title:"Messages",children:[e.jsx(z,{title:"Messages"}),e.jsx("div",{className:"py-6 lg:py-0",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-0",children:e.jsx($,{className:"overflow-hidden",children:e.jsxs("div",{className:"flex h-[calc(100vh-12rem)] md:h-[calc(100vh-10rem)] overflow-hidden",children:[e.jsxs("div",{className:"w-full md:w-80 md:flex-none md:max-w-80 border-r flex flex-col min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-medium truncate",children:"Chats"}),e.jsxs("button",{onClick:()=>m(!0),className:"rounded-full w-8 h-8 p-0 flex items-center justify-center bg-primary text-white hover:bg-primary/90 transition-colors shrink-0",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),e.jsx("span",{className:"sr-only",children:"New conversation"})]})]}),e.jsx(J,{conversations:l,activeConversationId:u,onSearchChange:S,onSelectConversation:L})]}),e.jsx("div",{className:"hidden md:flex flex-1 min-w-0 overflow-hidden",children:u?e.jsx(G,{conversationId:u,auth:c,onConversationRead:M,onConversationIncrementUnread:E,onAfterSend:U}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-muted/10",children:e.jsxs("div",{className:"text-center max-w-md p-6",children:[e.jsx("div",{className:"mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),e.jsx("h3",{className:"text-xl font-medium mb-2",children:"Your Messages"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a conversation to view messages or start a new one."}),e.jsx("button",{onClick:()=>m(!0),className:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors",children:"Start a Conversation"})]})})})]})})})}),e.jsx(K,{isOpen:i,onClose:()=>m(!1),onCreateConversation:k})]})}export{ht as default};
