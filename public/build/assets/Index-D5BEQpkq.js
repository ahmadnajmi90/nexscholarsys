import{q as P,j as e,r as a,a as D,Y as U}from"./app-BfGWvB7w.js";import{C as q}from"./card-D-wjmK2K.js";import"./scroll-area-DKiTudyr.js";import{c as B}from"./utils-CIsb_jhR.js";import{A as $,l as W,T as G}from"./ThreadPane-C6vXaian.js";import{i as Y,f as z}from"./AttachmentPreviewModal-BiCcSrvb.js";import{c as H}from"./en-US-DNUEYIb-.js";import{c as J}from"./constructNow-DtVD-0hX.js";import{a as K}from"./addDays-CAl2nVVE.js";import{B as F}from"./button-Cq3fupve.js";import{A as R,a as O}from"./avatar-DBW4jV_K.js";import{M as Q}from"./MainLayout-4268IGPQ.js";import{c as V}from"./index-BJH3I2kF.js";import"./index-YHrrFQIB.js";import"./index-ateNRHzS.js";import"./index-KEiRbh2J.js";import"./clsx-B-dksMZM.js";import"./Modal-DFFVucdS.js";import"./dialog-CgKOv2f-.js";import"./transition-Da2sQ5nr.js";import"./file-text-kQD_s7cs.js";import"./createLucideIcon-Czp2GFly.js";import"./x-D1Znm3Ot.js";import"./house-NZyoQ2Gd.js";import"./zap-Cw9F8qzn.js";import"./users-ZGU2Nc7F.js";import"./folder-open-D5Fqauh0.js";import"./settings-Brw_LBzQ.js";import"./useRoles-DTgiufjA.js";import"./chevron-left-CA2Vc_Fb.js";import"./proxy-BK-7vKaj.js";import"./user-round-RE_N2eX7.js";import"./clipboard-list-BYkGs1br.js";import"./dollar-sign-D41u08oN.js";import"./calendar-CbxFMwGp.js";import"./message-square-D2KqPL-R.js";import"./graduation-cap-Di4TbpZt.js";import"./building-MPGUl8Te.js";import"./Dropdown-CjvO5Ia5.js";import"./sparkles-DqVAnQpQ.js";import"./building-2-B342a_fD.js";import"./database-BK3F8EUr.js";import"./shield-ykj2ZmOn.js";import"./index-D0QXYS-s.js";import"./analytics-BQ374C1C.js";import"./PrimaryButton-DpeW9_ss.js";import"./SecondaryButton-h1KnshBt.js";import"./briefcase-CMlBsN0j.js";import"./user-B0PU8Qxt.js";function X(n,c,g){return K(n,-c,g)}function Z(n,c){return Y(H(n,n),X(J(n),1))}function ee(n){if(!n)return"";const c=new Date(n);return Y(c,new Date)?z(c,"h:mm aa"):Z(c)?"Yesterday":z(c,"dd/MM/yyyy")}function te({conversation:n,isActive:c,onSelect:g}){var s,r,o,d;const{id:p,title:m,type:b,participants:y,last_message:h,unread_count:f}=n,{auth:u}=P().props,w=Number(u.user.id),N=n.last_message_sender_id,_=(s=h==null?void 0:h.sender)==null?void 0:s.id,v=N!=null?Number(N):_!=null?Number(_):null,C=v!=null&&v===w,x=y.filter(l=>l.user_id!==w),j=b==="direct"&&x.length>0?(r=x[0])==null?void 0:r.user:null,S=(j==null?void 0:j.full_name)??(j==null?void 0:j.name)??m,k=()=>{var l;if(b==="direct"&&x.length>0){const i=(l=x[0])==null?void 0:l.user,A=(i==null?void 0:i.avatar_url)??(i==null?void 0:i.profile_photo_url);return e.jsx($,{src:A,alt:(i==null?void 0:i.full_name)||(i==null?void 0:i.name)||"User",size:40})}return e.jsx($,{src:null,alt:m,size:40})},L=ee((h==null?void 0:h.created_at)??n.updated_at),M=l=>l?l.type==="text"?(l.body??"").trim().replace(/\s+/g," "):l.type==="image"?"ðŸ“· Image":l.type==="file"?"ðŸ“Ž File":l.type==="system"?(l.body??"").trim().replace(/\s+/g," "):"":"No messages yet",I=()=>{g&&g(p)},T=M(h),t=`${C?"You: ":""}${T}`;return e.jsxs("div",{onClick:I,className:B("flex items-center gap-3 p-3 rounded-lg transition-colors cursor-pointer min-w-0 w-full overflow-hidden",c?"bg-primary/10 text-primary":"hover:bg-muted/50"),children:[e.jsxs("div",{className:"relative shrink-0",children:[k(),x.length>0&&((d=(o=x[0])==null?void 0:o.user)==null?void 0:d.is_online)&&e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between min-w-0",children:[e.jsx("h3",{className:"font-medium truncate pr-2 min-w-0 flex-1 overflow-hidden",title:S,children:S}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0 whitespace-nowrap",children:L})]}),e.jsxs("div",{className:"mt-0.5 flex items-center justify-between min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate pr-1 min-w-0 flex-1 break-words overflow-hidden",title:t,children:t}),f>0&&e.jsx("span",{className:"shrink-0 ml-1 flex items-center justify-center w-5 h-5 text-xs font-medium text-white bg-primary rounded-full",children:f})]})]})]})}function se({conversations:n=[],activeConversationId:c=null,onSearchChange:g,onSelectConversation:p}){const[m,b]=a.useState("");P();const y=W.debounce(f=>{g&&g(f)},300),h=f=>{const u=f.target.value;b(u),y(u)};return a.useEffect(()=>()=>{y.cancel()},[]),e.jsxs("div",{className:"h-full flex flex-col min-w-0 overflow-hidden",children:[e.jsx("div",{className:"p-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search conversations...",value:m,onChange:h,className:"w-full p-2 pl-8 text-sm bg-muted/50 border-0 rounded-lg focus:ring-1 focus:ring-primary min-w-0"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsx("div",{className:"flex-1 min-w-0 overflow-y-auto overflow-x-hidden",children:e.jsx("div",{className:"p-3 space-y-1 min-w-0 overflow-hidden",children:n.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No conversations found"}):n.map(f=>e.jsx(te,{conversation:f,isActive:c===f.id,onSelect:p},f.id))})})]})}function re({isOpen:n,onClose:c,onCreateConversation:g}){const[p,m]=a.useState("direct"),[b,y]=a.useState(""),[h,f]=a.useState([]),[u,w]=a.useState([]),[N,_]=a.useState(""),[v,C]=a.useState(!1),[x,j]=a.useState(!1),S=async(t="")=>{C(!0);try{const s=await D.get("/api/v1/app/connections",{params:{q:t,per_page:50}});f(s.data.data||[])}catch(s){console.error("Error fetching connections:",s)}finally{C(!1)}},k=a.useMemo(()=>W.debounce(t=>{t.trim()&&S(t)},300),[]);a.useEffect(()=>{n&&S("")},[n]),a.useEffect(()=>{n&&b.trim()&&k(b)},[b,k,n]);const L=h,M=t=>{if(p==="direct")w([t]);else{const s=u.some(r=>r.id===t.id);w(s?u.filter(r=>r.id!==t.id):[...u,t])}},I=t=>u.some(s=>s.id===t),T=async()=>{if(!(p==="direct"&&u.length!==1||p==="group"&&(u.length<1||!N.trim()))){j(!0);try{const t=p==="direct"?{type:"direct",user_id:u[0].id}:{type:"group",title:N.trim(),user_ids:u.map(s=>s.id)};g&&await g(t),E()}catch(t){console.error("Error creating conversation:",t)}finally{j(!1)}}},E=()=>{m("direct"),y(""),w([]),_(""),c()};return n?e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-medium",children:"New Conversation"}),e.jsx("button",{onClick:E,className:"p-1 rounded-full hover:bg-muted",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{className:B("flex-1 py-3 text-center font-medium",p==="direct"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),onClick:()=>m("direct"),children:"Direct Message"}),e.jsx("button",{className:B("flex-1 py-3 text-center font-medium",p==="group"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),onClick:()=>m("group"),children:"Group Chat"})]}),p==="group"&&e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("label",{htmlFor:"group-title",className:"block text-sm font-medium text-gray-700 mb-1",children:"Group Name"}),e.jsx("input",{type:"text",id:"group-title",value:N,onChange:t=>_(t.target.value),placeholder:"Enter group name",className:"w-full p-2 border rounded-md",required:!0})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:`Search ${p==="direct"?"connections":"participants"}...`,value:b,onChange:t=>y(t.target.value),className:"w-full p-2 pl-8 border rounded-md"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-1",children:v?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):L.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No connections found"}):e.jsx("div",{className:"space-y-1",children:L.map(t=>{const s=t.user,r=I(s.id);return e.jsxs("div",{className:B("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",r?"bg-primary/10 text-primary":"hover:bg-muted/50"),onClick:()=>M(s),children:[e.jsxs("div",{className:"relative",children:[s.avatar_url?e.jsx(R,{src:s.avatar_url,alt:s.full_name||s.name}):e.jsx(R,{children:e.jsx(O,{className:"bg-primary/10 text-primary",children:(s.full_name||s.name||"U").charAt(0)})}),s.is_online===!0&&e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:s.full_name||s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.role||"Connection"})]}),r&&e.jsx("div",{className:"text-primary",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]},s.id)})})}),e.jsxs("div",{className:"p-4 border-t flex justify-end gap-2",children:[e.jsx(F,{variant:"outline",onClick:E,disabled:x,children:"Cancel"}),e.jsx(F,{onClick:T,disabled:x||p==="direct"&&u.length!==1||p==="group"&&(u.length<1||!N.trim()),children:x?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating..."})]}):"Create"})]})]})}):null}function Ze({auth:n}){const{flash:c,url:g}=P().props,[p,m]=a.useState([]),[b,y]=a.useState(!0),[h,f]=a.useState(""),[u,w]=a.useState(!1),[N,_]=a.useState(null),[v,C]=a.useState(null);a.useEffect(()=>{const s=new URLSearchParams(window.location.search).get("cid");s&&C(parseInt(s,10))},[]),a.useEffect(()=>{if(v){const t=new URLSearchParams(window.location.search);t.set("cid",v),window.history.replaceState({},"",`${window.location.pathname}?${t.toString()}`)}},[v]),a.useEffect(()=>{c.error&&V.error(c.error)},[c]),a.useEffect(()=>{x();const t=setInterval(()=>{D.post("/api/v1/app/me/heartbeat").catch(s=>console.error("Heartbeat error:",s))},3e4);return()=>clearInterval(t)},[]);const x=async(t="")=>{y(!0),_(null);try{const s=await D.get("/api/v1/app/messaging/conversations",{params:{q:t}});m(s.data.data||[])}catch(s){console.error("Error fetching conversations:",s),_("Failed to load conversations. Please try again.")}finally{y(!1)}},j=W.debounce(t=>{f(t),x(t)},300),S=async t=>{try{const r=(await D.post("/api/v1/app/messaging/conversations",t)).data.data;return m(o=>o.some(l=>l.id===r.id)?o:[r,...o]),C(r.id),r}catch(s){throw console.error("Error creating conversation:",s),s}},k=t=>{C(t)},L=t=>{m(s=>s.map(r=>r.id===t?{...r,unread_count:0}:r))},M=t=>{m(s=>s.map(r=>r.id===t?{...r,unread_count:(r.unread_count??0)+1}:r))},I=(t,s)=>{m(r=>{const o=r.findIndex(i=>i.id===t);if(o===-1)return r;const d={...r[o],last_message:s,updated_at:s.created_at},l=[...r.slice(0,o),...r.slice(o+1)];return[d,...l]})},T=(t,s)=>{m(r=>r.map(o=>o.id===t?{...o,unread_count:0}:o)),I(t,s)};a.useEffect(()=>{const t=window.Echo.private(`App.Models.User.${n.user.id}`);return t.listen(".MessageSent",s=>{s.conversation_id!==v&&M(s.conversation_id),I(s.conversation_id,s.message)}),t.listen(".MessageEdited",s=>{m(r=>r.map(o=>o.last_message&&o.last_message.id===s.id?{...o,last_message:{...o.last_message,body:s.body,edited_at:s.edited_at}}:o))}),t.listen(".MessageDeleted",s=>{x(h)}),t.listen(".ConversationListDelta",s=>{E(s)}),()=>{t.stopListening(".MessageSent"),t.stopListening(".MessageEdited"),t.stopListening(".MessageDeleted"),t.stopListening(".ConversationListDelta")}},[n.user.id,v,h]);const E=t=>{m(s=>{if(!s)return s;const r=[...s],o=r.findIndex(A=>String(A.id)===String(t.conversation_id));if(o===-1)return s;const d={...r[o]},l=t.last_message_sender_id!=null?Number(t.last_message_sender_id):null;d.updated_at=t.updated_at??d.updated_at,d.title=t.title??d.title,d.icon_path=t.icon_path??d.icon_path,l!==null&&(d.last_message_sender_id=l);const i=d.last_message??{};if(d.last_message={...i,body:t.last_message_preview??i.body??"",preview:t.last_message_preview??i.preview??"",type:t.last_message_type??i.type??"text",sender:l!==null?{...i.sender??{},id:l}:i.sender??null},typeof t.unread_delta=="number"){const A=d.unread_count??0;d.unread_count=Math.max(0,A+t.unread_delta)}return r.splice(o,1),r.unshift(d),r})};return e.jsxs(Q,{auth:n,title:"Messages",children:[e.jsx(U,{title:"Messages"}),e.jsx("div",{className:"py-6 lg:py-0",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-0",children:e.jsx(q,{className:"overflow-hidden",children:e.jsxs("div",{className:"flex h-[calc(100vh-12rem)] md:h-[calc(100vh-10rem)] overflow-hidden",children:[e.jsxs("div",{className:"w-full md:w-80 md:flex-none md:max-w-80 border-r flex flex-col min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-medium truncate",children:"Chats"}),e.jsxs("button",{onClick:()=>w(!0),className:"rounded-full w-8 h-8 p-0 flex items-center justify-center bg-primary text-white hover:bg-primary/90 transition-colors shrink-0",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),e.jsx("span",{className:"sr-only",children:"New conversation"})]})]}),e.jsx(se,{conversations:p,activeConversationId:v,onSearchChange:j,onSelectConversation:k})]}),e.jsx("div",{className:"hidden md:flex flex-1 min-w-0 overflow-hidden",children:v?e.jsx(G,{conversationId:v,auth:n,onConversationRead:L,onConversationIncrementUnread:M,onAfterSend:T}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-muted/10",children:e.jsxs("div",{className:"text-center max-w-md p-6",children:[e.jsx("div",{className:"mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),e.jsx("h3",{className:"text-xl font-medium mb-2",children:"Your Messages"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a conversation to view messages or start a new one."}),e.jsx("button",{onClick:()=>w(!0),className:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors",children:"Start a Conversation"})]})})})]})})})}),e.jsx(re,{isOpen:u,onClose:()=>w(!1),onCreateConversation:S})]})}export{Ze as default};
