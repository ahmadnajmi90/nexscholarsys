import{q as P,j as e,r as a,a as D,Y as U}from"./app-Ba9NEla_.js";import{C as q}from"./card-CqrB6JdE.js";import"./scroll-area-BOZ84QIi.js";import{c as B}from"./utils-D-KgF5mV.js";import{A as $,l as W,T as G}from"./ThreadPane-Cqf1kDNR.js";import{i as Y}from"./isSameDay-Dm-A-V7S.js";import{f as z}from"./format-Dv9Rm441.js";import{c as H}from"./en-US-DNUEYIb-.js";import{c as J}from"./constructNow-DtVD-0hX.js";import{a as K}from"./addDays-CAl2nVVE.js";import{B as F}from"./button-BEWen7a0.js";import{A as R,a as O}from"./avatar-DYCjIyUA.js";import{M as Q}from"./MainLayout-Bilbkvhv.js";import{c as V}from"./index-DW2eQRph.js";import"./index-CDEssc61.js";import"./index-B75IAngf.js";import"./index-xQoiVGlk.js";import"./index-C_0yBoYj.js";import"./index-BdQq_4o_.js";import"./Modal-C3pBVycS.js";import"./dialog-DI12n2Mi.js";import"./transition-DxPkQ6VA.js";import"./AttachmentPreviewModal-B45-mygi.js";import"./file-text-dcTnRxuT.js";import"./createLucideIcon-D9Xjp5kf.js";import"./download-BeZ9RuNE.js";import"./x-DVH-fLs-.js";import"./house-aWaz0F0q.js";import"./zap-6gUBymt_.js";import"./users-DHlOkeZx.js";import"./folder-open-BpD49sAT.js";import"./settings-v8GNLW_X.js";import"./useRoles-CuVmpppE.js";import"./chevron-left-CPXqezQ0.js";import"./proxy-Av63RA2h.js";import"./user-round-CFmIIlMD.js";import"./clipboard-list-DlgffZW3.js";import"./dollar-sign-Dd0pz-mR.js";import"./calendar-BvXP8mpX.js";import"./message-square-Bj0KoFlw.js";import"./graduation-cap-CaNWWPpW.js";import"./building-ChspdInA.js";import"./Dropdown-BhhpvDIO.js";import"./sparkles-BUu_m5kF.js";import"./bookmark-zZLb7SgC.js";import"./folder-kanban-tY3ET3td.js";import"./building-2-DRNQvE42.js";import"./database-D8l3daMq.js";import"./shield-BXSM-Q_F.js";import"./index-DBU4d1mm.js";import"./analytics-BQ374C1C.js";import"./index-B8ly8vOf.js";import"./supervisionConstants-BuM5-H5X.js";import"./PrimaryButton-pwHuaSyw.js";import"./SecondaryButton-BYvENvvQ.js";import"./chevron-right-hyKbPlMM.js";import"./search-FWjCe4AE.js";import"./circle-check-big-BoAppQCr.js";import"./tooltip-DP5RCaPk.js";import"./index-15aMhqW_.js";import"./index-edx9cnCL.js";import"./index-BnwPfEVg.js";import"./floating-ui.dom-eiE65J5j.js";import"./index-doDk9rCk.js";import"./index-DKkZd806.js";import"./index-D4cTQj6_.js";import"./briefcase-BIppSgpY.js";import"./user-2l1TcTd-.js";function X(n,c,g){return K(n,-c,g)}function Z(n,c){return Y(H(n,n),X(J(n),1))}function ee(n){if(!n)return"";const c=new Date(n);return Y(c,new Date)?z(c,"h:mm aa"):Z(c)?"Yesterday":z(c,"dd/MM/yyyy")}function te({conversation:n,isActive:c,onSelect:g}){var r,s,o,d;const{id:p,title:m,type:b,participants:y,last_message:h,unread_count:f}=n,{auth:u}=P().props,w=Number(u.user.id),N=n.last_message_sender_id,_=(r=h==null?void 0:h.sender)==null?void 0:r.id,v=N!=null?Number(N):_!=null?Number(_):null,C=v!=null&&v===w,x=y.filter(l=>l.user_id!==w),j=b==="direct"&&x.length>0?(s=x[0])==null?void 0:s.user:null,S=(j==null?void 0:j.full_name)??(j==null?void 0:j.name)??m,k=()=>{var l;if(b==="direct"&&x.length>0){const i=(l=x[0])==null?void 0:l.user,A=(i==null?void 0:i.avatar_url)??(i==null?void 0:i.profile_photo_url);return e.jsx($,{src:A,alt:(i==null?void 0:i.full_name)||(i==null?void 0:i.name)||"User",size:40})}return e.jsx($,{src:null,alt:m,size:40})},L=ee((h==null?void 0:h.created_at)??n.updated_at),M=l=>l?l.type==="text"?(l.body??"").trim().replace(/\s+/g," "):l.type==="image"?"ðŸ“· Image":l.type==="file"?"ðŸ“Ž File":l.type==="system"?(l.body??"").trim().replace(/\s+/g," "):"":"No messages yet",I=()=>{g&&g(p)},T=M(h),t=`${C?"You: ":""}${T}`;return e.jsxs("div",{onClick:I,className:B("flex items-center gap-3 p-3 rounded-lg transition-colors cursor-pointer min-w-0 w-full overflow-hidden",c?"bg-primary/10 text-primary":"hover:bg-muted/50"),children:[e.jsxs("div",{className:"relative shrink-0",children:[k(),x.length>0&&((d=(o=x[0])==null?void 0:o.user)==null?void 0:d.is_online)&&e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between min-w-0",children:[e.jsx("h3",{className:"font-medium truncate pr-2 min-w-0 flex-1 overflow-hidden",title:S,children:S}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0 whitespace-nowrap",children:L})]}),e.jsxs("div",{className:"mt-0.5 flex items-center justify-between min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate pr-1 min-w-0 flex-1 break-words overflow-hidden",title:t,children:t}),f>0&&e.jsx("span",{className:"shrink-0 ml-1 flex items-center justify-center w-5 h-5 text-xs font-medium text-white bg-primary rounded-full",children:f})]})]})]})}function re({conversations:n=[],activeConversationId:c=null,onSearchChange:g,onSelectConversation:p}){const[m,b]=a.useState("");P();const y=W.debounce(f=>{g&&g(f)},300),h=f=>{const u=f.target.value;b(u),y(u)};return a.useEffect(()=>()=>{y.cancel()},[]),e.jsxs("div",{className:"h-full flex flex-col min-w-0 overflow-hidden",children:[e.jsx("div",{className:"p-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search conversations...",value:m,onChange:h,className:"w-full p-2 pl-8 text-sm bg-muted/50 border-0 rounded-lg focus:ring-1 focus:ring-primary min-w-0"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsx("div",{className:"flex-1 min-w-0 overflow-y-auto overflow-x-hidden",children:e.jsx("div",{className:"p-3 space-y-1 min-w-0 overflow-hidden",children:n.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No conversations found"}):n.map(f=>e.jsx(te,{conversation:f,isActive:c===f.id,onSelect:p},f.id))})})]})}function se({isOpen:n,onClose:c,onCreateConversation:g}){const[p,m]=a.useState("direct"),[b,y]=a.useState(""),[h,f]=a.useState([]),[u,w]=a.useState([]),[N,_]=a.useState(""),[v,C]=a.useState(!1),[x,j]=a.useState(!1),S=async(t="")=>{C(!0);try{const r=await D.get("/api/v1/app/connections",{params:{q:t,per_page:50}});f(r.data.data||[])}catch(r){console.error("Error fetching connections:",r)}finally{C(!1)}},k=a.useMemo(()=>W.debounce(t=>{t.trim()&&S(t)},300),[]);a.useEffect(()=>{n&&S("")},[n]),a.useEffect(()=>{n&&b.trim()&&k(b)},[b,k,n]);const L=h,M=t=>{if(p==="direct")w([t]);else{const r=u.some(s=>s.id===t.id);w(r?u.filter(s=>s.id!==t.id):[...u,t])}},I=t=>u.some(r=>r.id===t),T=async()=>{if(!(p==="direct"&&u.length!==1||p==="group"&&(u.length<1||!N.trim()))){j(!0);try{const t=p==="direct"?{type:"direct",user_id:u[0].id}:{type:"group",title:N.trim(),user_ids:u.map(r=>r.id)};g&&await g(t),E()}catch(t){console.error("Error creating conversation:",t)}finally{j(!1)}}},E=()=>{m("direct"),y(""),w([]),_(""),c()};return n?e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-medium",children:"New Conversation"}),e.jsx("button",{onClick:E,className:"p-1 rounded-full hover:bg-muted",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{className:B("flex-1 py-3 text-center font-medium",p==="direct"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),onClick:()=>m("direct"),children:"Direct Message"}),e.jsx("button",{className:B("flex-1 py-3 text-center font-medium",p==="group"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),onClick:()=>m("group"),children:"Group Chat"})]}),p==="group"&&e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("label",{htmlFor:"group-title",className:"block text-sm font-medium text-gray-700 mb-1",children:"Group Name"}),e.jsx("input",{type:"text",id:"group-title",value:N,onChange:t=>_(t.target.value),placeholder:"Enter group name",className:"w-full p-2 border rounded-md",required:!0})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:`Search ${p==="direct"?"connections":"participants"}...`,value:b,onChange:t=>y(t.target.value),className:"w-full p-2 pl-8 border rounded-md"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-1",children:v?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):L.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No connections found"}):e.jsx("div",{className:"space-y-1",children:L.map(t=>{const r=t.user,s=I(r.id);return e.jsxs("div",{className:B("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",s?"bg-primary/10 text-primary":"hover:bg-muted/50"),onClick:()=>M(r),children:[e.jsxs("div",{className:"relative",children:[r.avatar_url?e.jsx(R,{src:r.avatar_url,alt:r.full_name||r.name}):e.jsx(R,{children:e.jsx(O,{className:"bg-primary/10 text-primary",children:(r.full_name||r.name||"U").charAt(0)})}),r.is_online===!0&&e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:r.full_name||r.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.role||"Connection"})]}),s&&e.jsx("div",{className:"text-primary",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]},r.id)})})}),e.jsxs("div",{className:"p-4 border-t flex justify-end gap-2",children:[e.jsx(F,{variant:"outline",onClick:E,disabled:x,children:"Cancel"}),e.jsx(F,{onClick:T,disabled:x||p==="direct"&&u.length!==1||p==="group"&&(u.length<1||!N.trim()),children:x?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating..."})]}):"Create"})]})]})}):null}function gt({auth:n}){const{flash:c,url:g}=P().props,[p,m]=a.useState([]),[b,y]=a.useState(!0),[h,f]=a.useState(""),[u,w]=a.useState(!1),[N,_]=a.useState(null),[v,C]=a.useState(null);a.useEffect(()=>{const r=new URLSearchParams(window.location.search).get("cid");r&&C(parseInt(r,10))},[]),a.useEffect(()=>{if(v){const t=new URLSearchParams(window.location.search);t.set("cid",v),window.history.replaceState({},"",`${window.location.pathname}?${t.toString()}`)}},[v]),a.useEffect(()=>{c.error&&V.error(c.error)},[c]),a.useEffect(()=>{x();const t=setInterval(()=>{D.post("/api/v1/app/me/heartbeat").catch(r=>console.error("Heartbeat error:",r))},3e4);return()=>clearInterval(t)},[]);const x=async(t="")=>{y(!0),_(null);try{const r=await D.get("/api/v1/app/messaging/conversations",{params:{q:t}});m(r.data.data||[])}catch(r){console.error("Error fetching conversations:",r),_("Failed to load conversations. Please try again.")}finally{y(!1)}},j=W.debounce(t=>{f(t),x(t)},300),S=async t=>{try{const s=(await D.post("/api/v1/app/messaging/conversations",t)).data.data;return m(o=>o.some(l=>l.id===s.id)?o:[s,...o]),C(s.id),s}catch(r){throw console.error("Error creating conversation:",r),r}},k=t=>{C(t)},L=t=>{m(r=>r.map(s=>s.id===t?{...s,unread_count:0}:s))},M=t=>{m(r=>r.map(s=>s.id===t?{...s,unread_count:(s.unread_count??0)+1}:s))},I=(t,r)=>{m(s=>{const o=s.findIndex(i=>i.id===t);if(o===-1)return s;const d={...s[o],last_message:r,updated_at:r.created_at},l=[...s.slice(0,o),...s.slice(o+1)];return[d,...l]})},T=(t,r)=>{m(s=>s.map(o=>o.id===t?{...o,unread_count:0}:o)),I(t,r)};a.useEffect(()=>{const t=window.Echo.private(`App.Models.User.${n.user.id}`);return t.listen(".MessageSent",r=>{r.conversation_id!==v&&M(r.conversation_id),I(r.conversation_id,r.message)}),t.listen(".MessageEdited",r=>{m(s=>s.map(o=>o.last_message&&o.last_message.id===r.id?{...o,last_message:{...o.last_message,body:r.body,edited_at:r.edited_at}}:o))}),t.listen(".MessageDeleted",r=>{x(h)}),t.listen(".ConversationListDelta",r=>{E(r)}),()=>{t.stopListening(".MessageSent"),t.stopListening(".MessageEdited"),t.stopListening(".MessageDeleted"),t.stopListening(".ConversationListDelta")}},[n.user.id,v,h]);const E=t=>{m(r=>{if(!r)return r;const s=[...r],o=s.findIndex(A=>String(A.id)===String(t.conversation_id));if(o===-1)return r;const d={...s[o]},l=t.last_message_sender_id!=null?Number(t.last_message_sender_id):null;d.updated_at=t.updated_at??d.updated_at,d.title=t.title??d.title,d.icon_path=t.icon_path??d.icon_path,l!==null&&(d.last_message_sender_id=l);const i=d.last_message??{};if(d.last_message={...i,body:t.last_message_preview??i.body??"",preview:t.last_message_preview??i.preview??"",type:t.last_message_type??i.type??"text",sender:l!==null?{...i.sender??{},id:l}:i.sender??null},typeof t.unread_delta=="number"){const A=d.unread_count??0;d.unread_count=Math.max(0,A+t.unread_delta)}return s.splice(o,1),s.unshift(d),s})};return e.jsxs(Q,{auth:n,title:"Messages",children:[e.jsx(U,{title:"Messages"}),e.jsx("div",{className:"py-6 lg:py-0",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-0",children:e.jsx(q,{className:"overflow-hidden",children:e.jsxs("div",{className:"flex h-[calc(100vh-12rem)] md:h-[calc(100vh-10rem)] overflow-hidden",children:[e.jsxs("div",{className:"w-full md:w-80 md:flex-none md:max-w-80 border-r flex flex-col min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-medium truncate",children:"Chats"}),e.jsxs("button",{onClick:()=>w(!0),className:"rounded-full w-8 h-8 p-0 flex items-center justify-center bg-primary text-white hover:bg-primary/90 transition-colors shrink-0",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),e.jsx("span",{className:"sr-only",children:"New conversation"})]})]}),e.jsx(re,{conversations:p,activeConversationId:v,onSearchChange:j,onSelectConversation:k})]}),e.jsx("div",{className:"hidden md:flex flex-1 min-w-0 overflow-hidden",children:v?e.jsx(G,{conversationId:v,auth:n,onConversationRead:L,onConversationIncrementUnread:M,onAfterSend:T}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-muted/10",children:e.jsxs("div",{className:"text-center max-w-md p-6",children:[e.jsx("div",{className:"mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),e.jsx("h3",{className:"text-xl font-medium mb-2",children:"Your Messages"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a conversation to view messages or start a new one."}),e.jsx("button",{onClick:()=>w(!0),className:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors",children:"Start a Conversation"})]})})})]})})})}),e.jsx(se,{isOpen:u,onClose:()=>w(!1),onCreateConversation:S})]})}export{gt as default};
